

{% assign airport = site.data.airports | where: "icao", page.icao | first %}
{% if airport and airport.coordinates and airport.coordinates != "[]" %}
  {% include map-single.html coordinates=airport.coordinates military=false %}
{% endif %}


<h2>IFR Charts</h2>

<a href="https://deltazulusim.short.gy/charts/{{ page.icao | downcase }}" class="btn btn--success">
    <i class="fas fa-download"></i> Download
</a>



{% assign airport = site.data.airports | where: "icao", page.icao | first %}
{% if airport and airport.documents and airport.documents.size > 0 %}

<h2>VFR Charts</h2>
<button id="togglePdfButton" class="btn btn--success"><i class="fas fa-eye"></i> View</button>

<div id="pdfContainer" class="pdf-container" style="display: none;">
    <button id="prevDoc" class="prev-doc btn btn-secondary">Previous Document</button>
    <button id="nextDoc" class="next-doc btn btn-secondary">Next Document</button>
    <p class="loading-text">Loading PDF...</p>
    <div id="pdfViewer" class="pdf-scroll-container"></div>
</div>

<style>
    .pdf-container {
        margin-top: 10px;
        position: relative;
    }
    
    .pdf-scroll-container {
        overflow-y: auto;
        height: 600px;
        border: 1px solid #ddd;
        padding: 0;
        margin: 0;
        background-color: #f8f8f8;
        position: relative;
    }

    .open-external {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        color: #007bff;
        cursor: pointer;
        text-decoration: none;
        background: white;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0px 2px 4px rgba(0,0,0,0.2);
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = '{{ "/assets/js/pdf.js/pdf.worker.js" | relative_url }}';

    // âœ… Extracting the URLs dynamically from Jekyll YAML data
    var pdfUrls = [
        {% for doc in airport.documents %}
            "{{ doc }}"{% unless forloop.last %}, {% endunless %}
        {% endfor %}
    ];

    var currentIndex = 0;
    var toggleButton = document.getElementById("togglePdfButton");
    var pdfContainer = document.getElementById("pdfContainer");
    var pdfViewer = document.getElementById("pdfViewer");
    var loadingText = document.querySelector(".loading-text");
    var prevDocBtn = document.getElementById("prevDoc");
    var nextDocBtn = document.getElementById("nextDoc");

    let pdfLoadingTask = null;
    let renderTask = null;
    let isLoading = false;

    function disableButtonsForTwoSeconds() {
        toggleButton.disabled = true;
        prevDocBtn.disabled = true;
        nextDocBtn.disabled = true;

        setTimeout(() => {
            toggleButton.disabled = false;
            prevDocBtn.disabled = (currentIndex === 0);
            nextDocBtn.disabled = (currentIndex === pdfUrls.length - 1);
        }, 2000);
    }

    async function loadPDF(pdfUrl) {
        disableButtonsForTwoSeconds();
        pdfViewer.innerHTML = "";
        loadingText.style.display = "block";

        try {
            if (pdfUrl.includes("drive.google.com")) {
                let fileId = pdfUrl.match(/\/d\/(.*?)\//);
                if (fileId) {
                    pdfUrl = `https://drive.google.com/file/d/${fileId[1]}/preview`;
                }

                let iframe = document.createElement("iframe");
                iframe.src = pdfUrl;
                iframe.width = "100%";
                iframe.height = "600px";
                iframe.style.border = "none";

                pdfViewer.appendChild(iframe);
                loadingText.style.display = "none";
                return;
            }

            pdfLoadingTask = pdfjsLib.getDocument({ url: pdfUrl });
            let pdfDoc = await pdfLoadingTask.promise;
            loadingText.style.display = "none";

            let page = await pdfDoc.getPage(1);
            let scale = 1.5;
            let viewport = page.getViewport({ scale: scale });

            let canvas = document.createElement("canvas");
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pdfViewer.appendChild(canvas);

            let ctx = canvas.getContext("2d");
            let renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            renderTask = page.render(renderContext);
            await renderTask.promise;

        } catch (error) {
            console.error("Error loading PDF:", error);
            loadingText.textContent = "Failed to load PDF. Click View again.";
        }
    }

    prevDocBtn.addEventListener("click", function () {
        if (!isLoading && currentIndex > 0) {
            currentIndex--;
            disableButtonsForTwoSeconds();
            loadPDF(pdfUrls[currentIndex]);
        }
    });

    nextDocBtn.addEventListener("click", function () {
        if (!isLoading && currentIndex < pdfUrls.length - 1) {
            currentIndex++;
            disableButtonsForTwoSeconds();
            loadPDF(pdfUrls[currentIndex]);
        }
    });

    toggleButton.addEventListener("click", function () {
        disableButtonsForTwoSeconds();
        let icon = this.querySelector("i");
        let textNode = this.querySelector("span"); // Target the span for text

        if (pdfContainer.style.display === "block") {
            pdfContainer.style.display = "none";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
            textNode.textContent = " View";
            toggleButton.classList.remove("btn-danger");
            toggleButton.classList.add("btn-success");
        } else {
            pdfContainer.style.display = "block";
            loadPDF(pdfUrls[currentIndex]);
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
            textNode.textContent = " Close";
            toggleButton.classList.remove("btn-success");
            toggleButton.classList.add("btn-danger");
        }
    });

    prevDocBtn.disabled = (currentIndex === 0);
    nextDocBtn.disabled = (currentIndex === pdfUrls.length - 1);
});
</script>

{% endif %}

{% if page.svg_charts %}

  <h2 class="expand-title" onclick="toggleExpand(this)">
    <span class="expand-symbol"></span> IFR Charts Viewer
    <a class="header-link" href="#ifrcharts" title="Permalink" id="changelog">
      <span class="sr-only">Permalink</span>
      <i class="fas fa-link"></i>
    </a>
  </h2>

{% capture content %}

<div style="display: flex; height: 100vh;">
  <!-- Sidebar for titles -->
  <div id="sidebar" style="width: 30%; overflow-y: auto; background: #f0f0f0; padding: 10px; border-right: 1px solid #ccc;">
    <!-- Titles will be added here dynamically -->
  </div>

  <!-- Viewer for charts -->
  <div id="viewer" style="width: 70%; padding: 10px; position: relative;">
    <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">
      <button id="zoomIn" style="padding: 5px 10px; font-size: 12px;">âž•</button>
      <button id="zoomOut" style="padding: 5px 10px; font-size: 12px;">âž–</button>
      <button id="resetZoom" style="padding: 5px 10px; font-size: 12px;">ðŸ”„</button>
    </div>
    <div id="svgScrollContainer" style="width: 100%; height: 100%; overflow: auto; border: 1px solid #ccc; background: white;">
      <div id="svgContainer" style="transform-origin: top left;"></div>
    </div>
  </div>
</div>


<script>

  let activeButton = null;

  const githubUser = "{{ page.svg_charts.github_user }}";
  const githubRepo = "{{ page.svg_charts.github_repo }}";
  const branch = "{{ page.svg_charts.branch }}";
  const icao = "{{ page.svg_charts.icao }}";

  const charts = [
    {% for item in page.svg_charts.files %}
      {
        title: "{{ item.ref }} {{ item.title }}",
        url: `https://raw.githubusercontent.com/${githubUser}/${githubRepo}/refs/heads/${branch}/${icao}/{{ item.file }}`
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];




const sidebar = document.getElementById('sidebar');
const svgScrollContainer = document.getElementById('svgScrollContainer'); // âœ… Select the scrollable container
const svgContainer = document.getElementById('svgContainer');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const resetZoomBtn = document.getElementById('resetZoom');



let zoomLevel = 1;

// Create sidebar buttons dynamically
charts.forEach((chart) => {
  const button = document.createElement('button');
  button.textContent = chart.title;
  button.style.display = "block";
  button.style.width = "100%";
  button.style.marginBottom = "5px";
  button.style.padding = "10px";
  button.style.border = "none";
  button.style.textAlign = "left";
  button.style.cursor = "pointer";
  button.style.background = "#ffffff";
  button.style.borderBottom = "1px solid #ddd";
  button.style.fontSize = "10px";

  button.addEventListener('click', () => {
  loadSVG(chart.url);

  // Highlight active button
  if (activeButton) {
    activeButton.style.backgroundColor = '#ffffff'; // Reset previous
    activeButton.style.color = '#000000';
  }
  button.style.backgroundColor = '#007bff'; // Bootstrap blue or whatever you want
  button.style.color = '#ffffff'; // White text
  activeButton = button;
});

  sidebar.appendChild(button);
});

// ADD this after defining your constants:
const zoomLevelDisplay = document.createElement('div');
zoomLevelDisplay.style.position = 'absolute';
zoomLevelDisplay.style.top = '10px';
zoomLevelDisplay.style.left = '10px';
zoomLevelDisplay.style.backgroundColor = 'rgba(255,255,255,0.8)';
zoomLevelDisplay.style.padding = '5px 10px';
zoomLevelDisplay.style.borderRadius = '5px';
zoomLevelDisplay.style.fontSize = '12px';
zoomLevelDisplay.style.fontWeight = 'bold';
zoomLevelDisplay.style.zIndex = '10';
document.getElementById('viewer').appendChild(zoomLevelDisplay);



// Load SVG function
async function loadSVG(url) {
  svgContainer.innerHTML = "Loading chart...";
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("Failed to fetch SVG");
    let reversedBase64 = await response.text();

    // Clean it (remove spaces, newlines)
    reversedBase64 = reversedBase64.trim().replace(/\s+/g, '');

    // âž¡ï¸ Unobfuscate: Reverse it back
    const base64 = reversedBase64.split('').reverse().join('');

    // âž¡ï¸ Decode Base64
    const svgText = atob(base64);

    svgContainer.innerHTML = svgText;

    const svgElement = svgContainer.querySelector('svg');
    if (svgElement) {
      svgElement.setAttribute('width', '100%');
      svgElement.setAttribute('height', 'auto');
      svgElement.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    }

    zoomLevel = 1;
    applyZoom();
  } catch (err) {
    svgContainer.innerHTML = "Error loading chart.";
    console.error(err);
  }
}

// Modify your applyZoom function:
function applyZoom() {
  svgContainer.style.transform = `scale(${zoomLevel})`;
  zoomLevelDisplay.textContent = `${Math.round(zoomLevel * 100)}%`;
}

zoomInBtn.addEventListener('click', () => {
  zoomLevel += 0.2;
  applyZoom();
});

zoomOutBtn.addEventListener('click', () => {
  zoomLevel = Math.max(0.2, zoomLevel - 0.2);
  applyZoom();
});

resetZoomBtn.addEventListener('click', () => {
  zoomLevel = 1;
  applyZoom();
  svgScrollContainer.scrollLeft = 0; 
  svgScrollContainer.scrollTop = 0;  

  svgScrollContainer.style.overflow = 'hidden';
setTimeout(() => {
  svgScrollContainer.style.overflow = 'auto';
}, 50);
});

svgScrollContainer.addEventListener('dblclick', (e) => {
  zoomLevel += 0.5; // Zoom in faster with double-click
  applyZoom();
});


// Load the first chart by default
loadSVG(charts[0].url);

// ðŸ–ï¸ Add Dragging functionality
let isDragging = false;
let startX, startY, scrollLeft, scrollTop;

svgScrollContainer.addEventListener('mousedown', (e) => {
  isDragging = true;
  startX = e.pageX - svgScrollContainer.offsetLeft;
  startY = e.pageY - svgScrollContainer.offsetTop;
  scrollLeft = svgScrollContainer.scrollLeft;
  scrollTop = svgScrollContainer.scrollTop;
  svgScrollContainer.style.cursor = "grabbing"; // Change cursor
});

svgScrollContainer.addEventListener('mouseleave', () => {
  isDragging = false;
  svgScrollContainer.style.cursor = "default";
});

svgScrollContainer.addEventListener('mouseup', () => {
  isDragging = false;
  svgScrollContainer.style.cursor = "default";
});

svgScrollContainer.addEventListener('wheel', (e) => {
  if (e.ctrlKey) { // Only if Ctrl is pressed
    e.preventDefault(); // Stop the browser zoom
    if (e.deltaY < 0) {
      zoomLevel += 0.1; // Zoom In
    } else {
      zoomLevel = Math.max(0.2, zoomLevel - 0.1); // Zoom Out
    }
    applyZoom();
  }
}, { passive: false });


svgScrollContainer.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  e.preventDefault();
  const x = e.pageX - svgScrollContainer.offsetLeft;
  const y = e.pageY - svgScrollContainer.offsetTop;
  const walkX = (x - startX) * 1; // Sensitivity
  const walkY = (y - startY) * 1; // Sensitivity
  svgScrollContainer.scrollLeft = scrollLeft - walkX;
  svgScrollContainer.scrollTop = scrollTop - walkY;
});

let lastTouchDistance = null;

svgScrollContainer.addEventListener('touchmove', (e) => {
  if (e.touches.length === 2) { // 2 fingers
    e.preventDefault(); // Prevent scrolling page
    const touch1 = e.touches[0];
    const touch2 = e.touches[1];
    const currentTouchDistance = Math.hypot(
      touch2.pageX - touch1.pageX,
      touch2.pageY - touch1.pageY
    );

    if (lastTouchDistance) {
      if (currentTouchDistance > lastTouchDistance + 5) {
        zoomLevel += 0.02;
        applyZoom();
      } else if (currentTouchDistance < lastTouchDistance - 5) {
        zoomLevel = Math.max(0.2, zoomLevel - 0.02);
        applyZoom();
      }
    }
    lastTouchDistance = currentTouchDistance;
  }
}, { passive: false });

svgScrollContainer.addEventListener('touchend', () => {
  lastTouchDistance = null;
});

</script>
{% endcapture %}
{% include expand-content.html content=content %}
{% endif %}